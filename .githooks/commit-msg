#!/usr/bin/env bash
# Commit message validation hook for andweorc
#
# This hook validates commit messages follow conventional commit format:
#   <type>(<scope>): <description>
#
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore
# Scope: optional, e.g., (profiler), (macros), (cli)
#
# Examples:
#   feat(profiler): add delay injection for virtual speedup
#   fix: resolve race condition in sample collection
#   docs: update README with usage examples
#   test(profiler): add throughput accuracy validation
#
# Install with:
#   git config core.hooksPath .githooks

set -o errexit
set -o nounset
set -o pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits
if echo "$COMMIT_MSG" | grep -qE "^Merge "; then
    exit 0
fi

# Skip revert commits
if echo "$COMMIT_MSG" | grep -qE "^Revert "; then
    exit 0
fi

# Conventional commit pattern
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore
PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore)(\([a-z0-9_-]+\))?: .{1,72}"

# Check first line
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n1)

if ! echo "$FIRST_LINE" | grep -qE "$PATTERN"; then
    echo -e "${YELLOW}WARNING: Commit message does not follow conventional commit format${NC}"
    echo ""
    echo "Expected format: <type>(<scope>): <description>"
    echo ""
    echo "Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore"
    echo "Scope: optional, e.g., (profiler), (macros), (cli)"
    echo ""
    echo "Examples:"
    echo "  feat(profiler): add delay injection for virtual speedup"
    echo "  fix: resolve race condition in sample collection"
    echo "  docs: update README with usage examples"
    echo ""
    echo "Your message: $FIRST_LINE"
    echo ""
    # Warn but don't fail - conventional commits are recommended but not required
    # To make it required, uncomment the next line:
    # exit 1
fi

# Check line length (soft limit)
if [ ${#FIRST_LINE} -gt 72 ]; then
    echo -e "${YELLOW}WARNING: First line is ${#FIRST_LINE} characters (recommended: 72 max)${NC}"
fi

exit 0
